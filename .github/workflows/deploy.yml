name: Deploy theme to WP Engine Staging

on:
  push:
    branches: ["stage"]
  workflow_dispatch:

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Debug Output
        run: |
          echo "Theme directory structure:"
          ls -R wp-content/themes/lauras-mercantile-theme-gpt-dev/

      - name: Install React deps
        working-directory: "wp-content/themes/lauras-mercantile-theme-gpt-dev/react-src"
        run: npm ci --no-audit --no-fund

      - name: Build React
        working-directory: "wp-content/themes/lauras-mercantile-theme-gpt-dev/react-src"
        run: |
          rm -rf ../assets/dist/
          npm run build

      - name: Install SSH Key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.WPE_STAGING_SSH_KEY }}
          known_hosts: "placeholder" # We skip checking below
          if_key_exists: fail

      - name: Connectivity Check
        run: |
          echo "Testing connection to ${{ secrets.WPE_STAGING_HOST }} on port 22..."
          nc -zv -w 5 ${{ secrets.WPE_STAGING_HOST }} 22 || echo "Port 22 unreachable"

      - name: Deploy to Staging via SSH
        uses: easingthemes/ssh-deploy@main
        with:
          SSH_PRIVATE_KEY: ${{ secrets.WPE_STAGING_SSH_KEY }}
          ARGS: "-rlgoDzvvc -i --delete"
          SOURCE: "wp-content/themes/lauras-mercantile-theme-gpt-dev/"
          REMOTE_HOST: ${{ secrets.WPE_STAGING_HOST }}
          REMOTE_USER: ${{ secrets.WPE_STAGING_USER }}
          REMOTE_PORT: 22
          TARGET: "/sites/merc22stg/wp-content/themes/lauras-mercantile-theme-gpt-dev/"
          EXCLUDE: "/node_modules/, /react-src/, .git/"
          SSH_CMD_ARGS: "-o StrictHostKeyChecking=no"

      - name: Post-Deploy Commands (Cache Flush)
        run: |
          echo "Flushing WP Engine Cache..."
          ssh -p 22 -o StrictHostKeyChecking=no ${{ secrets.WPE_STAGING_USER }}@${{ secrets.WPE_STAGING_HOST }} "wp cache flush || true"

      - name: Deployment Summary
        run: |
          echo "ðŸš€ THEME DEPLOYMENT SUMMARY ðŸš€"
          echo "=================================="
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Status: Pushed to Staging"
